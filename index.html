<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Feliz Anivers√°rio, Helena!</title>
<style>
  :root{
    --accent:#FF3D84;
    --bg1:linear-gradient(180deg,#87CEFA 0%, #FFFAF0 62%);
    --card:rgba(255,255,255,.96);
    --shadow:0 8px 24px rgba(0,0,0,.12);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Helvetica Neue',Arial,sans-serif;background:var(--bg1);-webkit-font-smoothing:antialiased}
  #stage{position:relative;width:100vw;height:100vh;overflow:hidden;touch-action:none;padding-top:60px}
  .hud{position:fixed;left:12px;top:8px;z-index:400;font-weight:800}
  .controls{position:fixed;right:8px;top:8px;z-index:410;display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:var(--card);border-radius:12px;padding:8px 12px;box-shadow:var(--shadow);cursor:pointer;border:0;font-weight:800}
  .menuBtn{position:fixed;left:50%;transform:translateX(-50%);top:8px;z-index:420}
  .menuOverlay{position:fixed;inset:0;background:rgba(7,10,20,.45);display:none;align-items:center;justify-content:center;z-index:800}
  .menuCard{background:var(--card);padding:18px;border-radius:14px;box-shadow:var(--shadow);width:92%;max-width:760px}
  #gameArea{position:absolute;inset:0;z-index:10}
  #fxCanvas{position:absolute;left:0;top:0;width:100%;height:100%;z-index:30;pointer-events:none}
  .score{position:fixed;left:12px;bottom:14px;background:var(--card);padding:8px 12px;border-radius:12px;box-shadow:var(--shadow);z-index:400;font-weight:900}
  .lives{position:fixed;right:12px;bottom:14px;background:var(--card);padding:8px 12px;border-radius:12px;box-shadow:var(--shadow);z-index:400}
  .centerMsg{position:fixed;left:50%;top:38%;transform:translate(-50%,-50%);z-index:700;font-size:36px;font-weight:900;color:var(--accent);text-align:center;display:none;padding:12px;background:rgba(255,255,255,.95);border-radius:12px;box-shadow:var(--shadow)}
  .balloon{position:absolute;font-size:48px;z-index:120;cursor:pointer;user-select:none;touch-action:none;transform-origin:center}
  .present{position:fixed;right:12px;bottom:calc(16px + env(safe-area-inset-bottom));font-size:56px;z-index:400;background:var(--card);padding:6px;border-radius:10px;box-shadow:var(--shadow);cursor:pointer}

  /* ‚Äî‚Äî Overlay do presente com blur e cart√£o transl√∫cido ‚Äî‚Äî */
  .giftOverlay{position:fixed;inset:0;display:none;z-index:900}
  .giftBackdrop{position:absolute;inset:0;background:rgba(0,0,0,.28);backdrop-filter:blur(2px)}
  .giftCard{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(92vw,1000px); padding:24px 18px;
    background:rgba(255,255,255,.90); border:1px solid rgba(255,255,255,.85);
    border-radius:16px; box-shadow:0 18px 60px rgba(0,0,0,.28);
  }
  .giftClose{position:absolute; top:8px; right:8px; border:0; border-radius:10px;padding:6px 10px; font-weight:900; cursor:pointer; background:var(--card); box-shadow:var(--shadow)}
  .giftBox{text-align:center}
  .giftTitle{font-size:clamp(36px,7.2vw,86px); font-weight:900; color:#ff3d84; text-shadow:0 6px 18px rgba(0,0,0,.12)}
  .giftSubtitle{margin-top:8px; font-size:clamp(18px,3.8vw,28px); font-weight:800; color:#ff3d84}
  .giftCakeArea{margin-top:16px; display:flex; flex-direction:column; align-items:center; gap:8px}
  .giftCakeArea .bigcake{font-size:clamp(72px,10vw,120px); line-height:1}
  .giftCakeArea .hint{display:none} /* removemos a frase abaixo do bolo */
  .giftCakeArea .label{font-weight:800}

  /* Puzzle modal (central fixo, responsivo) */
  .puzzleModal{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    z-index:850; background:var(--card); border-radius:12px; padding:14px;
    box-shadow:0 16px 48px rgba(0,0,0,.28); display:none;
    width:min(96vw,560px); max-height:90vh; overflow:hidden;
  }
  .puzzleHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  #pCanvas{width:100%;height:420px;background:#f6f6f8;border-radius:6px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.04);touch-action:none}
  .puzzleControls{display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap}
  .smallBtn{padding:6px 8px;border-radius:8px}
  .closeX{background:transparent;border:0;font-weight:800;cursor:pointer}

  /* Mascotes flutuantes */
  @keyframes riseUp{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(-140vh) rotate(30deg);opacity:0}}
  .floating-unlock{position:absolute;font-size:56px;z-index:190;pointer-events:none;animation:riseUp 6s linear forwards}

  @media(max-width:600px){
    .btn{padding:6px 8px;font-size:13px}
    .present{font-size:52px}
    .centerMsg{font-size:28px}
    #pCanvas{height:360px}
  }
</style>
</head>
<body>
  <div id="stage" role="application" aria-label="Surpresa interativa">
    <div id="gameArea"></div>
    <canvas id="fxCanvas" aria-hidden="true"></canvas>

    <div class="hud">Surpresa de Anivers√°rio üéâ</div>
    <div class="controls">
      <button id="effectsBtn" class="btn" aria-pressed="true">üîä Efeitos: ON</button>
      <button id="modeBtn" class="btn">Modo: Casual</button>
      <button id="menuOpen" class="btn menuBtn">‚ãØ Menu</button>
    </div>

    <div class="menuOverlay" id="menuOverlay" aria-hidden="true">
      <div class="menuCard" role="dialog" aria-modal="true">
        <h2>Op√ß√µes</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
          <button id="casualMode" class="btn">Casual (3 anos)</button>
          <button id="challengeMode" class="btn">Desafio (vidas)</button>
          <button id="survivalMode" class="btn">Sobreviv√™ncia (tempo)</button>
          <button id="puzzleMode" class="btn">Brincadeira (Puzzle)</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <label style="font-weight:800">Salvar records:</label>
          <button id="toggleSave" class="btn">Salvar: ON</button>
        </div>
        <div style="margin-top:10px">
          <strong>Records</strong>
          <div>Maior Pontua√ß√£o: <span id="bestScore">0</span></div>
          <div>Maior Tempo (s): <span id="bestTime">0</span></div>
          <div>Melhor Puzzle: <span id="bestPuzzle">0</span></div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="resetRecords" class="btn">Limpar records</button>
          <button id="menuClose" class="btn">Fechar</button>
        </div>
      </div>
    </div>

    <!-- Overlay central do presente -->
    <div id="giftOverlay" class="giftOverlay" aria-hidden="true">
      <div class="giftBackdrop" id="giftBackdrop"></div>
      <div class="giftCard" role="dialog" aria-modal="true" aria-label="Parab√©ns para Helena">
        <button id="giftClose" class="giftClose" aria-label="Fechar">‚úï</button>
        <div class="giftBox">
          <div id="giftTitle" class="giftTitle">FELIZ ANIVERS√ÅRIO, HELENA!!</div>
          <div id="giftSubtitle" class="giftSubtitle">Toque no bolo para alternar a mensagem</div>
          <div class="giftCakeArea">
            <div class="bigcake" id="cakeClick" role="button" tabindex="0" aria-label="Bolo">üéÇ</div>
            <div class="label">Bolo Surpresa</div>
          </div>
        </div>
      </div>
    </div>

    <div class="score" id="scoreBox">Pontos: <span id="score">0</span></div>
    <div class="lives" id="livesBox" style="display:none">Vidas: <span id="lives">5</span></div>
    <div class="centerMsg" id="centerMsg"></div>
    <button class="present" id="presentBtn" aria-label="Abrir presente">üéÅ</button>

    <!-- P U Z Z L E -->
    <div class="puzzleModal" id="puzzleModal" aria-hidden="true">
      <div class="puzzleHeader">
        <strong>Puzzle - Encaixe</strong>
        <div>
          <button id="puzzleRestart" class="btn smallBtn">Reiniciar</button>
          <button id="puzzleExit" class="btn smallBtn closeX">Sair ‚úï</button>
        </div>
      </div>
      <canvas id="pCanvas" width="420" height="420"></canvas>
      <div class="puzzleControls">
        <button id="pLeft" class="btn smallBtn">‚óÄ</button>
        <button id="pRotate" class="btn smallBtn">‚Üª</button>
        <button id="pRight" class="btn smallBtn">‚ñ∂</button>
        <button id="pDrop" class="btn smallBtn">Descer</button>
      </div>
    </div>
  </div>

<script>
/* ===== ELEMENTOS & ESTADO ===== */
const CHILD='HELENA';
const gameArea=document.getElementById('gameArea');
const fxCanvas=document.getElementById('fxCanvas'); const ctx=fxCanvas.getContext('2d');
const effectsBtn=document.getElementById('effectsBtn');
const modeBtn=document.getElementById('modeBtn');
const menuOpen=document.getElementById('menuOpen'); const menuOverlay=document.getElementById('menuOverlay'); const menuClose=document.getElementById('menuClose');
const scoreEl=document.getElementById('score'); const livesBox=document.getElementById('livesBox'); const livesEl=document.getElementById('lives'); const centerMsg=document.getElementById('centerMsg');
const presentBtn=document.getElementById('presentBtn');

const giftOverlay=document.getElementById('giftOverlay');
const giftBackdrop=document.getElementById('giftBackdrop');
const giftClose=document.getElementById('giftClose');
const cakeClick=document.getElementById('cakeClick');
const giftTitle=document.getElementById('giftTitle');
const giftSubtitle=document.getElementById('giftSubtitle');

const toggleSave=document.getElementById('toggleSave'); const bestScoreEl=document.getElementById('bestScore'); const bestTimeEl=document.getElementById('bestTime'); const bestPuzzleEl=document.getElementById('bestPuzzle'); const resetRecords=document.getElementById('resetRecords');

const pModal=document.getElementById('puzzleModal'); const pCanvas=document.getElementById('pCanvas'); const pctx=pCanvas.getContext('2d');
const pRestart=document.getElementById('puzzleRestart'); const pExit=document.getElementById('puzzleExit'); const pLeft=document.getElementById('pLeft'); const pRight=document.getElementById('pRight'); const pRotate=document.getElementById('pRotate'); const pDrop=document.getElementById('pDrop');

let FX_ON=true,audioCtx=null,RECORDS_ENABLED=true;
let MODE='casual', paused=false;
let score=0,poppedCount=0;
let balloons=[],particles=[],lastSpawn=0;
let SPAWN_RATE=1100,MAX_BALLOONS=8,LIVES=5;
let lastPhrase='',unlocked=new Set();
let presentMsgToggle=0;

/* ===== FRASES ===== */
const POP_PHRASES=['Muito bem!','Uhul!','Pop! Que legal!','Amo isso!','Voc√™ conseguiu!','Yay! Mais um!','Que r√°pido!'];
const MILESTONE_PHRASES=['Uau! Voc√™ arrasou!','Brilhante! üéâ','Que incr√≠vel!','Super estrela!','Parab√©ns, campe√£!'];
const UNLOCK_PHRASES=['Olha o unic√≥rnio!','Voc√™ desbloqueou um amigo!','Surpresa m√°gica!','Mais um amiguinho para brincar!'];
const MASCOT_EMOJIS=['ü¶Ñ','üß∏','üê±','üê∂','üêµ','üê•','üêù','üêº'];

/* ===== UTIL ===== */
function pickRandomDifferent(list){if(!list||list.length===0)return'';if(list.length===1)return list[0];let pick,tries=0;do{pick=list[Math.floor(Math.random()*list.length)];tries++;}while(pick===lastPhrase&&tries<6);lastPhrase=pick;return pick;}
function resizeCanvas(){const dpr=Math.max(1,window.devicePixelRatio||1);fxCanvas.width=Math.round(window.innerWidth*dpr);fxCanvas.height=Math.round(window.innerHeight*dpr);fxCanvas.style.width=window.innerWidth+'px';fxCanvas.style.height=window.innerHeight+'px';ctx.setTransform(dpr,0,0,dpr,0,0);}
window.addEventListener('resize',resizeCanvas);resizeCanvas();

function initAudio(){if(audioCtx)return;try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){audioCtx=null;}}
function playTone(freq,d=140,vol=0.03,type='sine',off=0){if(!audioCtx||!FX_ON)return;try{const t=audioCtx.currentTime+off/1000;const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type=type;o.frequency.setValueAtTime(freq,t);g.gain.setValueAtTime(0.0001,t);g.gain.exponentialRampToValueAtTime(vol,t+0.02);o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+d/1000+.02);}catch(e){}}
function chime(kind='pop'){if(!audioCtx||!FX_ON)return;if(kind==='pop')playTone(880,80,0.03,'triangle');else if(kind==='milestone'){playTone(660,150,0.03,'sine');playTone(880,160,0.02,'sine',100);}else if(kind==='unicorn'){playTone(880,120,0.03,'sine');playTone(1200,140,0.02,'sine',90);}else if(kind==='bear'){playTone(330,140,0.04,'square');playTone(250,140,0.03,'sine',90);}else if(kind==='cat'){playTone(1200,90,0.02,'triangle');playTone(1500,90,0.02,'triangle',80);}}

/* Fundo din√¢mico */
function updateBackground(){if(score<10)document.body.style.background='linear-gradient(180deg,#87CEFA 0%, #FFFAF0 62%)';else if(score<20)document.body.style.background='linear-gradient(180deg,#A8E6CF 0%, #FFF8E1 62%)';else if(score<40)document.body.style.background='linear-gradient(180deg,#FFD3B6 0%, #FFF8F0 62%)';else document.body.style.background='linear-gradient(180deg,#E0BBE4 0%, #FFF0F8 62%)';}

/* ===== BAL√ïES ===== */
function spawnBalloon(type='normal'){
  if(paused) return;
  if(balloons.length>=MAX_BALLOONS) return;
  const el=document.createElement('div'); el.className='balloon';
  let emoji='üéà',kind='pop',points=1;
  if(type==='unicorn'){emoji='ü¶Ñ';kind='unicorn';points=3;}
  if(type==='bear'){emoji='üß∏';kind='bear';points=2;}
  if(type==='cat'){emoji='üê±';kind='cat';points=2;}
  el.textContent=emoji;
  const x=Math.random()*(window.innerWidth-80)+40; let y=window.innerHeight+80;
  el.style.left=x+'px'; el.style.top=y+'px'; gameArea.appendChild(el);
  const b={el,x,y,vy:0.9+Math.random()*1.4,sway:Math.random()*0.7,popped:false,kind,points};
  el.addEventListener('pointerdown',(ev)=>{ev.stopPropagation(); if(b.popped) return; b.popped=true; popBalloon(b);},{passive:true});
  balloons.push(b);
}
function popBalloon(b){
  b.el.textContent='‚ú®'; b.el.style.transform='scale(1.12) rotate(6deg)'; chime(b.kind);
  score+=b.points; scoreEl.textContent=score; updateBackground(); poppedCount++;
  const pool=(b.kind==='unicorn')?['‚ú®','üíñ','üåà']:(b.kind==='bear')?['üíñ','üß∏','‚ú®']:(b.kind==='cat')?['‚ú®','üêæ','üíñ']:['‚ú®','üíñ','üåü'];
  for(let i=0;i<8;i++)spawnParticleEmoji(b.x+(Math.random()-0.5)*30,b.y-30+(Math.random()-0.5)*20,pool[Math.floor(Math.random()*pool.length)]);
  setTimeout(()=>{b.el.remove();},240);
  if(MODE==='casual'){showCenter(pickRandomDifferent(POP_PHRASES),900); if(Math.random()<0.35)spawnSmallMascot(b.x,b.y);}
  if(poppedCount%5===0){showCenter(pickRandomDifferent(MILESTONE_PHRASES),1200); chime('milestone'); spawnConfetti(window.innerWidth/2,window.innerHeight/2,30); SPAWN_RATE=Math.max(400,SPAWN_RATE-80); MAX_BALLOONS=Math.min(16,MAX_BALLOONS+1);}
  checkUnlocks();
}
function handleOffscreen(i){
  const b=balloons[i]; if(!b) return;
  if(b.y<-140){ b.el.remove(); balloons.splice(i,1);
    if(MODE==='challenge'){ LIVES--; livesEl.textContent=LIVES; chime('bear'); if(LIVES<=0) handleGameOver(); }
  }
}

/* ===== PART√çCULAS ===== */
function spawnParticleEmoji(x,y,emoji){particles.push({x,y,vx:(Math.random()-0.5)*6,vy:(-1-Math.random()*3),life:700+Math.random()*600,born:performance.now(),emoji,size:12+Math.random()*18,gravity:0.06});}
function spawnConfetti(x,y,qty=40){const colors=['#FF4DA6','#FFD166','#8AE6C1','#9CB4FF','#FFD1DC'];for(let i=0;i<qty;i++)particles.push({x,y,vx:(Math.random()-0.5)*8,vy:(-2-Math.random()*6),life:900+Math.random()*600,born:performance.now(),color:colors[Math.floor(Math.random()*colors.length)],w:6+Math.random()*10,h:10+Math.random()*20,gravity:0.06,rot:Math.random()*360});}
function spawnSparkles(x,y,qty=50){
  for(let i=0;i<qty;i++){
    const ang=Math.random()*Math.PI*2;
    const spd=2+Math.random()*4;
    const vx=Math.cos(ang)*spd, vy=Math.sin(ang)*spd-1.5;
    particles.push({x,y,vx,vy,life:900+Math.random()*700,born:performance.now(),emoji:Math.random()<0.5?'‚ú®':'üíñ',size:16+Math.random()*12,gravity:0.03});
  }
}

/* ===== DESBLOQUEIOS ===== */
const UNLOCKS=[{score:5,key:'unicorn',emoji:'ü¶Ñ'},{score:12,key:'bear',emoji:'üß∏'},{score:20,key:'cat',emoji:'üê±'}];
function checkUnlocks(){for(const u of UNLOCKS){if(score>=u.score&&!unlocked.has(u.key)){unlocked.add(u.key);spawnFloatingUnlock(u.emoji);spawnBalloon(u.key);showCenter(pickRandomDifferent(UNLOCK_PHRASES),1100);}}}
function spawnFloatingUnlock(emoji){const el=document.createElement('div');el.className='floating-unlock';el.textContent=emoji;const sx=window.innerWidth/2+(Math.random()-0.5)*160;const sy=window.innerHeight*0.65+(Math.random()-0.5)*40;el.style.left=sx+'px';el.style.top=sy+'px';gameArea.appendChild(el);el.addEventListener('animationend',()=>el.remove());}

/* ===== UI / MODOS / PAUSA ===== */
function showCenter(txt,ms=1000){centerMsg.textContent=txt;centerMsg.style.display='block';clearTimeout(centerMsg._t);centerMsg._t=setTimeout(()=>centerMsg.style.display='none',ms);}
effectsBtn.addEventListener('click',()=>{FX_ON=!FX_ON;effectsBtn.textContent=FX_ON?'üîä Efeitos: ON':'üîá Efeitos: OFF'; if(!audioCtx) initAudio();});

/* abrir menu (pausa) */
menuOpen.addEventListener('click',()=>{
  paused = true;
  giftOverlay.style.display='none';
  giftOverlay.setAttribute('aria-hidden','true');
  menuOverlay.style.display='flex';
  menuOverlay.setAttribute('aria-hidden','false');
});
menuClose.addEventListener('click',()=>{menuOverlay.style.display='none';menuOverlay.setAttribute('aria-hidden','true');paused=false;});
document.getElementById('casualMode').addEventListener('click',()=>{setMode('casual');closeMenu();});
document.getElementById('challengeMode').addEventListener('click',()=>{setMode('challenge');closeMenu();});
document.getElementById('survivalMode').addEventListener('click',()=>{setMode('survival');closeMenu();});
document.getElementById('puzzleMode').addEventListener('click',()=>{setMode('puzzle');closeMenu();openPuzzle();});
function closeMenu(){menuOverlay.style.display='none';menuOverlay.setAttribute('aria-hidden','true');paused=false;}
function setMode(m){MODE=m;modeBtn.textContent='Modo: '+(m==='casual'?'Casual':m==='challenge'?'Desafio':m==='survival'?'Sobreviv√™ncia':'Puzzle');for(const b of balloons){b.el.remove();}balloons.length=0;particles.length=0;score=0;poppedCount=0;scoreEl.textContent='0';SPAWN_RATE=m==='casual'?1300:m==='challenge'?1000:1200;MAX_BALLOONS=m==='casual'?6:m==='challenge'?8:6;LIVES=5;livesEl.textContent=LIVES;livesBox.style.display=(m==='challenge')?'block':'none';unlocked.clear();updateBackground();}

/* ===== PRESENTE / OVERLAY ===== */
function openGift(){giftOverlay.style.display='block';giftOverlay.setAttribute('aria-hidden','false');paused=true;}
function closeGift(){giftOverlay.style.display='none';giftOverlay.setAttribute('aria-hidden','true');paused=false;}
presentBtn.addEventListener('click', ()=>{
  presentMsgToggle = 0;
  giftTitle.textContent = `FELIZ ANIVERS√ÅRIO, ${CHILD}!!`;
  giftSubtitle.textContent = 'Toque no bolo para alternar a mensagem';
  openGift();
  fireworksAtTitle();           // confetes/estrelas acima da mensagem
});
giftClose.addEventListener('click', closeGift);
giftBackdrop.addEventListener('click', closeGift);

/* clica no bolo: alterna mensagens + fogos no topo do t√≠tulo */
cakeClick.addEventListener('click', ()=>{
  if (presentMsgToggle === 0) {
    giftTitle.textContent = 'A dinda Thami e o dindo Gabi amam muito voc√™!';
    giftSubtitle.textContent = 'üéàüéâ';
    presentMsgToggle = 1;
  } else {
    giftTitle.textContent = `FELIZ ANIVERS√ÅRIO, ${CHILD}!!`;
    giftSubtitle.textContent = 'Toque no bolo para alternar a mensagem';
    presentMsgToggle = 0;
  }
  if(!audioCtx) initAudio(); chime('pop');
  fireworksAtTitle();
});

/* fogos na √°rea do t√≠tulo (acima do texto) */
function fireworksAtTitle(){
  const r = giftTitle.getBoundingClientRect();
  const cx = r.left + r.width/2;
  const cy = Math.max(20, r.top - 12);
  spawnConfetti(cx, cy, 90);
  spawnSparkles(cx, cy, 90);
}

/* ===== RECORDS ===== */
const KEY_BEST_SCORE='hb_best_score',KEY_BEST_TIME='hb_best_time',KEY_BEST_PUZZLE='hb_best_puzzle';
function updateRecordsUI(){bestScoreEl.textContent=Number(localStorage.getItem(KEY_BEST_SCORE)||0);bestTimeEl.textContent=Number(localStorage.getItem(KEY_BEST_TIME)||0);bestPuzzleEl.textContent=Number(localStorage.getItem(KEY_BEST_PUZZLE)||0);}
toggleSave.addEventListener('click',()=>{RECORDS_ENABLED=!RECORDS_ENABLED;toggleSave.textContent=RECORDS_ENABLED?'Salvar: ON':'Salvar: OFF';});
resetRecords.addEventListener('click',()=>{localStorage.removeItem(KEY_BEST_SCORE);localStorage.removeItem(KEY_BEST_TIME);localStorage.removeItem(KEY_BEST_PUZZLE);updateRecordsUI();showCenter('Records limpos',900);});
updateRecordsUI();

/* ===== GAME OVER (desafio) ===== */
function handleGameOver(){SPAWN_RATE=999999;showCenter('Game Over üòÖ',1500);setTimeout(()=>{setMode('challenge');},1100);}

/* ===== LOOP ===== */
let lastFrame=performance.now();
function animate(now){
  const dt=now-lastFrame; lastFrame=now;
  if(!paused && now-lastSpawn>SPAWN_RATE){
    if(Math.random()<0.06){const r=Math.random(); if(r<0.25)spawnBalloon('unicorn'); else if(r<0.55)spawnBalloon('bear'); else spawnBalloon('cat');}
    else spawnBalloon('normal');
    lastSpawn=now;
  }
  if(!paused){
    for(let i=balloons.length-1;i>=0;i--){
      const b=balloons[i]; b.y-=b.vy*(dt/16);
      const sway=Math.sin((now/600)+b.sway*10)*18; b.x+=(sway*0.0009)*(dt/16);
      b.el.style.top=b.y+'px'; b.el.style.left=b.x+'px';
      if(b.y<-140) handleOffscreen(i);
    }
  }
  // part√≠culas
  ctx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
  const keep=[]; for(const p of particles){const age=now-p.born; if(age>p.life)continue; p.vy+=(p.gravity||0.04)*(dt/16); p.x+=p.vx*(dt/16); p.y+=p.vy*(dt/16); const a=Math.max(0,1-(age/p.life)); ctx.globalAlpha=a; if(p.emoji){ctx.font=(p.size||18)+'px serif'; ctx.fillText(p.emoji,p.x,p.y);} else {ctx.save(); ctx.translate(p.x,p.y); ctx.rotate((p.rot||0)*Math.PI/180*(age/500)); ctx.fillStyle=p.color||'#fff'; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();} ctx.globalAlpha=1; keep.push(p);}
  particles.length=0; particles.push(...keep);
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

/* ===== MASCOTES VISUAIS ===== */
function spawnSmallMascot(x,y){const m=MASCOT_EMOJIS[Math.floor(Math.random()*MASCOT_EMOJIS.length)];const el=document.createElement('div');el.className='floating-unlock';el.style.fontSize='40px';el.textContent=m;el.style.left=(x+(Math.random()-0.5)*40)+'px';el.style.top=y+'px';gameArea.appendChild(el);el.addEventListener('animationend',()=>el.remove());}

/* ===== PUZZLE (tetris-lite) + TECLADO + GESTOS ===== */
const GCOL=10,GROW=18,CELL=22; let grid=[],cur=null,ptimer=null,pspeed=550,pscore=0,pgameOver=false;
const SHAPES=[[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]]];
const COLORS=['#60a5fa','#fbbf24','#a78bfa','#22c55e','#fb7185','#38bdf8','#f59e0b'];

let keyHandlerAttached=false, touchHandlerAttached=false;
let touchStartX=0,touchStartY=0,touchMoved=false;

function pInit(){
  grid=Array.from({length:GROW},()=>Array(GCOL).fill(0)); pscore=0; pgameOver=false; pspeed=550;
  newPiece(); autoFitCanvas(); drawGrid(); runLoop();
}
function openPuzzle(){
  document.body.style.overflow='hidden';
  pModal.style.display='block';pModal.setAttribute('aria-hidden','false');paused=true; pCanvas.tabIndex=0; pCanvas.focus();
  pInit(); attachPuzzleInputs();
}
pExit.addEventListener('click',()=>{closePuzzle();});
pRestart.addEventListener('click',()=>pInit());
function closePuzzle(){stopLoop(); pModal.style.display='none';pModal.setAttribute('aria-hidden','true');paused=false; document.body.style.overflow=''; detachPuzzleInputs();}
function newPiece(){const i=Math.floor(Math.random()*SHAPES.length);const m=SHAPES[i];cur={m,x:3,y:0,color:COLORS[i]}; if(collide(0,0,cur.m)) {pgameOver=true; stopLoop(); showCenter('Puzzle: Game Over',1200);} }
function rotate(m){const r=m[0].map((_,i)=>m.map(row=>row[i]).reverse());return r;}
function collide(dx,dy,mat){for(let y=0;y<mat.length;y++){for(let x=0;x<mat[0].length;x++){if(mat[y][x]){const nx=cur.x+x+dx, ny=cur.y+y+dy; if(nx<0||nx>=GCOL||ny>=GROW|| (ny>=0 && grid[ny][nx])) return true;}}}return false;}
function merge(){for(let y=0;y<cur.m.length;y++){for(let x=0;x<cur.m[0].length;x++){if(cur.m[y][x] && cur.y+y>=0){grid[cur.y+y][cur.x+x]=cur.color;}}}}
function clearLines(){let lines=0;for(let y=GROW-1;y>=0;y--){if(grid[y].every(v=>v)){grid.splice(y,1);grid.unshift(Array(GCOL).fill(0));lines++;y++;}} if(lines){pscore+=lines*10; if(RECORDS_ENABLED){const best=Number(localStorage.getItem('hb_best_puzzle')||0); if(pscore>best){localStorage.setItem('hb_best_puzzle',pscore); updateRecordsUI();}}}}
function step(){ if(pgameOver) return; if(!collide(0,1,cur.m)){cur.y++;} else {merge(); clearLines(); newPiece();} drawGrid();}
function drawGrid(){pctx.clearRect(0,0,pCanvas.width,pCanvas.height); pctx.save(); pctx.translate(10,10);
  for(let y=0;y<GROW;y++){for(let x=0;x<GCOL;x++){const v=grid[y][x]; if(v){pctx.fillStyle=v; pctx.fillRect(x*CELL,y*CELL,CELL-1,CELL-1);}}}
  if(cur){pctx.fillStyle=cur.color; for(let y=0;y<cur.m.length;y++){for(let x=0;x<cur.m[0].length;x++){if(cur.m[y][x] && cur.y+y>=0){pctx.fillRect((cur.x+x)*CELL,(cur.y+y)*CELL,CELL-1,CELL-1);}}}}
  pctx.strokeStyle='rgba(0,0,0,.06)'; for(let x=0;x<=GCOL;x++){pctx.beginPath();pctx.moveTo(x*CELL,0);pctx.lineTo(x*CELL,GROW*CELL);pctx.stroke();}
  for(let y=0;y<=GROW;y++){pctx.beginPath();pctx.moveTo(0,y*CELL);pctx.lineTo(GCOL*CELL,y*CELL);pctx.stroke();}
  pctx.restore();
}
function runLoop(){stopLoop(); ptimer=setInterval(step,pspeed);}
function stopLoop(){if(ptimer){clearInterval(ptimer);ptimer=null;}}

/* Teclado (desktop) */
function onKey(e){
  if(pModal.getAttribute('aria-hidden')==='true') return;
  const k=e.key;
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown',' ','Escape','Esc','r','R'].includes(k)) e.preventDefault();
  if(k==='ArrowLeft'){ if(!collide(-1,0,cur.m)){cur.x--;drawGrid();} }
  if(k==='ArrowRight'){ if(!collide(1,0,cur.m)){cur.x++;drawGrid();} }
  if(k==='ArrowUp'){ const r=rotate(cur.m); if(!collide(0,0,r)){cur.m=r;drawGrid();} }
  if(k==='ArrowDown' || k===' '){ while(!collide(0,1,cur.m))cur.y++; step(); }
  if(k==='Escape' || k==='Esc'){ closePuzzle(); }
  if(k==='r' || k==='R'){ pInit(); }
}

/* Gestos (mobile) */
const SWIPE_T=22;
let touchStartX=0,touchStartY=0,touchMoved=false;
function onTouchStart(ev){if(ev.touches.length>1)return;touchMoved=false;touchStartX=ev.touches[0].clientX;touchStartY=ev.touches[0].clientY;}
function onTouchMove(ev){
  if(ev.touches.length>1) return;
  const dx=ev.touches[0].clientX-touchStartX;
  const dy=ev.touches[0].clientY-touchStartY;
  ev.preventDefault();
  if(Math.abs(dx)>SWIPE_T && Math.abs(dx)>Math.abs(dy)){
    touchMoved=true;
    if(dx<0){ if(!collide(-1,0,cur.m)){cur.x--;drawGrid();} }
    else   { if(!collide(1,0,cur.m)){cur.x++;drawGrid();} }
    touchStartX=ev.touches[0].clientX;
  }else if(dy>SWIPE_T && Math.abs(dy)>Math.abs(dx)){
    touchMoved=true;
    while(!collide(0,1,cur.m))cur.y++;
    step();
    touchStartY=ev.touches[0].clientY;
  }
}
function onTouchEnd(ev){
  const dx=(ev.changedTouches?.[0]?.clientX||0)-touchStartX;
  const dy=(ev.changedTouches?.[0]?.clientY||0)-touchStartY;
  if(!touchMoved && Math.abs(dx)<10 && Math.abs(dy)<10){
    const r=rotate(cur.m); if(!collide(0,0,r)){cur.m=r;drawGrid();}
  }
}
function attachPuzzleInputs(){
  if(!keyHandlerAttached){window.addEventListener('keydown',onKey,{passive:false}); keyHandlerAttached=true;}
  if(!touchHandlerAttached){
    pCanvas.addEventListener('touchstart',onTouchStart,{passive:false});
    pCanvas.addEventListener('touchmove',onTouchMove,{passive:false});
    pCanvas.addEventListener('touchend',onTouchEnd,{passive:false});
    touchHandlerAttached=true;
  }
}
function detachPuzzleInputs(){
  if(keyHandlerAttached){window.removeEventListener('keydown',onKey,{passive:false}); keyHandlerAttached=false;}
  if(touchHandlerAttached){
    pCanvas.removeEventListener('touchstart',onTouchStart,{passive:false});
    pCanvas.removeEventListener('touchmove',onTouchMove,{passive:false});
    pCanvas.removeEventListener('touchend',onTouchEnd,{passive:false});
    touchHandlerAttached=false;
  }
}
function autoFitCanvas(){const maxH=Math.min(420,Math.floor(window.innerHeight*0.55));pCanvas.style.height=maxH+'px';}

/* ===== BOOT ===== */
document.body.addEventListener('pointerdown',()=>{if(!audioCtx) initAudio(); if(audioCtx && audioCtx.state==='suspended') audioCtx.resume().catch(()=>{});},{once:true,passive:true});
function prime(){resizeCanvas(); setMode('casual'); lastSpawn=performance.now(); for(let i=0;i<3;i++) setTimeout(()=>spawnBalloon(), i*250);}
prime();
</script>
</body>
</html>
