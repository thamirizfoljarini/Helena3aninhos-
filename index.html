<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Feliz Anivers√°rio, Helena!</title>
<style>
  :root{--accent:#FF3D84;--bg1:linear-gradient(180deg,#87CEFA 0%, #FFFAF0 62%);--card:rgba(255,255,255,.96);--shadow:0 8px 24px rgba(0,0,0,.12)}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Helvetica Neue',Arial,sans-serif;background:var(--bg1);-webkit-font-smoothing:antialiased}
  #stage{position:relative;width:100vw;height:100vh;overflow:hidden;touch-action:none;padding-top:60px}
  .hud{position:fixed;left:12px;top:8px;z-index:400;font-weight:800}
  .controls{position:fixed;right:8px;top:8px;z-index:410;display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:var(--card);border-radius:12px;padding:8px 12px;box-shadow:var(--shadow);cursor:pointer;border:0;font-weight:800}
  .menuBtn{position:fixed;left:50%;transform:translateX(-50%);top:8px;z-index:420}
  .menuOverlay{position:fixed;inset:0;background:rgba(7,10,20,.45);display:none;align-items:center;justify-content:center;z-index:800}
  .menuCard{background:var(--card);padding:18px;border-radius:14px;box-shadow:var(--shadow);width:92%;max-width:760px}
  #gameArea{position:absolute;inset:0;z-index:10;pointer-events:auto}
  #fxCanvas{position:absolute;left:0;top:0;width:100%;height:100%;z-index:30;pointer-events:none}
  .score{position:fixed;left:12px;bottom:14px;background:var(--card);padding:8px 12px;border-radius:12px;box-shadow:var(--shadow);z-index:400;font-weight:900}
  .lives{position:fixed;right:12px;bottom:14px;background:var(--card);padding:8px 12px;border-radius:12px;box-shadow:var(--shadow);z-index:400}
  .centerMsg{position:fixed;left:50%;top:40%;transform:translate(-50%,-50%);z-index:700;font-size:36px;font-weight:900;color:var(--accent);text-align:center;display:none;padding:12px;background:rgba(255,255,255,.95);border-radius:12px;box-shadow:var(--shadow)}
  /* === PRESENTE: estiliza√ß√£o restaurada √† vers√£o inicial === */
  .present{position:fixed;right:12px;bottom:calc(16px + env(safe-area-inset-bottom));font-size:56px;z-index:400;background:var(--card);padding:6px;border-radius:10px;box-shadow:var(--shadow);cursor:pointer}
  /* Cake area (modal-like but simple) */
  .boxOverlay{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:900;background:transparent}
  .boxCard{background:var(--card);padding:18px;border-radius:14px;box-shadow:var(--shadow);text-align:center;max-width:420px;width:88%}
  .cakeEmoji{font-size:84px}
  .candles{display:flex;gap:12px;justify-content:center;margin-top:8px}
  .vela{font-size:28px;cursor:pointer;user-select:none}
  .messageOut{position:fixed;left:50%;top:8%;transform:translateX(-50%);z-index:600;background:rgba(255,255,255,.95);padding:8px 12px;border-radius:12px;box-shadow:var(--shadow);font-weight:900;display:none;max-width:90%;text-align:center}
  .balloon{position:absolute;font-size:48px;z-index:80;cursor:pointer;user-select:none;touch-action:none}
  .floating-unlock{position:absolute;font-size:56px;z-index:190;pointer-events:none;animation:riseUp 6s linear forwards}
  @keyframes riseUp{0%{transform:translateY(0) rotate(0deg);opacity:1}100%{transform:translateY(-140vh) rotate(30deg);opacity:0}}
  @media(max-width:600px){ .btn{padding:6px 8px;font-size:13px} .present{font-size:52px} .centerMsg{font-size:28px} .boxCard{padding:12px} }
</style>
</head>
<body>
  <div id="stage" role="application" aria-label="Surpresa interativa">
    <div id="gameArea" aria-live="polite"></div>
    <canvas id="fxCanvas" aria-hidden="true"></canvas>

    <div class="hud">Surpresa de Anivers√°rio üéâ</div>
    <div class="controls">
      <button id="effectsBtn" class="btn" aria-pressed="true">üîä Efeitos: ON</button>
      <button id="modeBtn" class="btn">Modo: Casual</button>
      <button id="menuOpen" class="btn menuBtn">‚ãØ Menu</button>
    </div>

    <div class="menuOverlay" id="menuOverlay" aria-hidden="true">
      <div class="menuCard" role="dialog" aria-modal="true">
        <h2>Op√ß√µes</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
          <button id="casualMode" class="btn">Casual (3 anos)</button>
          <button id="challengeMode" class="btn">Desafio (vidas)</button>
          <button id="survivalMode" class="btn">Sobreviv√™ncia (tempo)</button>
          <button id="puzzleMode" class="btn">Brincadeira (Puzzle)</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <label style="font-weight:800">Salvar records:</label>
          <button id="toggleSave" class="btn">Salvar: ON</button>
        </div>
        <div style="margin-top:10px">
          <strong>Records</strong>
          <div>Maior Pontua√ß√£o: <span id="bestScore">0</span></div>
          <div>Maior Tempo (s): <span id="bestTime">0</span></div>
          <div>Melhor Puzzle: <span id="bestPuzzle">0</span></div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="resetRecords" class="btn">Limpar records</button>
          <button id="menuClose" class="btn">Fechar</button>
        </div>
      </div>
    </div>

    <div class="messageOut" id="messageOut" role="status" aria-live="polite"></div>

    <div id="cakePlace"></div>

    <div class="score" id="scoreBox">Pontos: <span id="score">0</span></div>
    <div class="lives" id="livesBox" style="display:none">Vidas: <span id="lives">5</span></div>

    <div class="centerMsg" id="centerMsg"></div>

    <button class="present" id="presentBtn" aria-label="Abrir presente">üéÅ</button>

    <!-- Box modal (cake & candles) -->
    <div class="boxOverlay" id="boxOverlay" aria-hidden="true">
      <div class="boxCard" role="dialog" aria-modal="true">
        <div style="display:flex;justify-content:flex-end;">
          <button id="closeBox" class="btn">Fechar</button>
        </div>
        <div class="cakeEmoji">üéÇ</div>
        <div class="candles" id="candlesContainer"></div>
        <div style="margin-top:12px;font-weight:900;color:var(--accent)" id="boxMessage">FELIZ ANIVERS√ÅRIO, HELENA!!</div>
        <div style="margin-top:10px"><small>Tape nas velas para soprar ‚Äî 3 cliques apagam tudo</small></div>
      </div>
    </div>

  </div>

<script>
/* -------------------------
  C√≥digo corregido ‚Äî vers√£o restaurada + corre√ß√µes
  - Mantive o estilo do presente exatamente como no in√≠cio
  - Mensagens OUTFIELD (messageOut) ‚Äî N√ÉO ficam dentro da caixa
  - Bal√µes aparecem e sobem (n√£o travados)
  - Caixa abre/fecha m√∫ltiplas vezes; velas resetam a cada abertura
  - 3 cliques apagam as velas; mensagem separada exibida
  - Challenge: perder vida ao deixar bal√£o passar; acerto = estourar bal√£o
--------------------------*/

const CHILD = 'HELENA';

/* Elements */
const gameArea = document.getElementById('gameArea');
const fxCanvas = document.getElementById('fxCanvas');
const ctx = fxCanvas.getContext('2d');

const effectsBtn = document.getElementById('effectsBtn');
const modeBtn = document.getElementById('modeBtn');
const menuOpen = document.getElementById('menuOpen');
const menuOverlay = document.getElementById('menuOverlay');
const menuClose = document.getElementById('menuClose');

const presentBtn = document.getElementById('presentBtn');
const boxOverlay = document.getElementById('boxOverlay');
const closeBox = document.getElementById('closeBox');
const candlesContainer = document.getElementById('candlesContainer');
const boxMessage = document.getElementById('boxMessage');

const messageOut = document.getElementById('messageOut');
const scoreBox = document.getElementById('scoreBox');
const scoreEl = scoreBox.querySelector('#score');
const livesBox = document.getElementById('livesBox');
const livesEl = livesBox.querySelector('#lives');
const centerMsg = document.getElementById('centerMsg');

const casualBtn = document.getElementById('casualMode');
const challengeBtn = document.getElementById('challengeMode');
const survivalBtn = document.getElementById('survivalMode');
const puzzleBtn = document.getElementById('puzzleMode');
const toggleSave = document.getElementById('toggleSave');
const bestScoreEl = document.getElementById('bestScore');
const bestTimeEl = document.getElementById('bestTime');
const bestPuzzleEl = document.getElementById('bestPuzzle');
const resetRecords = document.getElementById('resetRecords');

/* State */
let FX_ON = true, audioCtx = null;
let MODE = 'casual'; // casual, challenge, survival, puzzle
let RECORDS_ENABLED = true;
let score = 0, poppedCount = 0;
let balloons = [], particles = [], lastSpawn = 0;
let SPAWN_RATE = 1100, MAX_BALLOONS = 8;
let LIVES = 5;
let survivalStart = null;
let lastPhrase = '';
let candleClicks = 0;

/* Records keys */
const KEY_BEST_SCORE = 'hb_best_score';
const KEY_BEST_TIME = 'hb_best_time';
const KEY_BEST_PUZZLE = 'hb_best_puzzle';

/* Phrase pools & mascots */
const POP_PHRASES = ['Muito bem!','Uhul!','Pop! Que legal!','Amo isso!','Voc√™ conseguiu!','Yay! Mais um!','Que r√°pido!','Lindo!'];
const MILESTONE_PHRASES = ['Uau! Voc√™ arrasou!','Brilhante! üéâ','Que incr√≠vel!','Super estrela!','Parab√©ns, campe√£!','Estrela do dia!'];
const UNLOCK_PHRASES = ['Olha o unic√≥rnio!','Voc√™ desbloqueou um amigo!','Surpresa m√°gica!','Mais um amiguinho para brincar!','Que fofura!'];
const MASCOT_EMOJIS = ['ü¶Ñ','üß∏','üê±','üê∂','üêµ','üê•','üêù','üêº'];

function pickRandomDifferent(list){
  if(!list || list.length===0) return '';
  if(list.length===1) return list[0];
  let pick, attempts=0;
  do{ pick = list[Math.floor(Math.random()*list.length)]; attempts++; } while(pick === lastPhrase && attempts < 8);
  lastPhrase = pick;
  return pick;
}

/* Canvas resize (particles) */
function resizeCanvas(){ const dpr = Math.max(1, window.devicePixelRatio || 1); fxCanvas.width = Math.round(window.innerWidth * dpr); fxCanvas.height = Math.round(window.innerHeight * dpr); fxCanvas.style.width = window.innerWidth + 'px'; fxCanvas.style.height = window.innerHeight + 'px'; ctx.setTransform(dpr,0,0,dpr,0,0); }
window.addEventListener('resize', resizeCanvas); resizeCanvas();

/* Audio helpers */
function initAudio(){ if(audioCtx) return; try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ audioCtx=null; console.warn('Audio indispon√≠vel'); } }
function playTone(freq, duration=160, vol=0.03, type='sine', offset=0){ if(!audioCtx || !FX_ON) return; try{ const t=audioCtx.currentTime + offset/1000; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=type; o.frequency.setValueAtTime(freq,t); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(vol,t+0.02); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+duration/1000+.02);}catch(e){} }
function chime(kind='pop'){ if(!audioCtx || !FX_ON) return; if(kind==='pop') playTone(880,80,0.03,'triangle'); else if(kind==='unicorn'){ playTone(880,120,0.03,'sine'); playTone(1200,140,0.02,'sine',90);} else if(kind==='bear'){ playTone(330,140,0.04,'square'); playTone(250,140,0.03,'sine',90);} else if(kind==='cat'){ playTone(1200,90,0.02,'triangle'); playTone(1500,90,0.02,'triangle',80);} else if(kind==='milestone'){ playTone(660,150,0.03,'sine'); playTone(880,160,0.025,'sine',100); } }

/* Center message */
function showCenter(msg, ms=1000){ centerMsg.textContent = msg; centerMsg.style.display='block'; setTimeout(()=> centerMsg.style.display='none', ms); }

/* Particles */
function spawnParticleEmoji(x,y,emoji){ particles.push({x,y,vx:(Math.random()-0.5)*6,vy:(-1-Math.random()*3),life:700+Math.random()*600,born:performance.now(),emoji,size:12+Math.random()*18,gravity:0.06}); }
function spawnConfetti(x,y,qty=40){ const colors=['#FF4DA6','#FFD166','#8AE6C1','#9CB4FF','#FFD1DC']; for(let i=0;i<qty;i++) particles.push({x,y,vx:(Math.random()-0.5)*8,vy:(-2-Math.random()*6),life:900 + Math.random()*600,born:performance.now(),color:colors[Math.floor(Math.random()*colors.length)],w:6+Math.random()*10,h:10+Math.random()*20,gravity:0.06,rot:Math.random()*360}); }

/* Floating mascots */
function spawnSmallMascot(x,y){ const emoji = MASCOT_EMOJIS[Math.floor(Math.random()*MASCOT_EMOJIS.length)]; const el=document.createElement('div'); el.className='floating-unlock'; el.style.fontSize='40px'; el.textContent=emoji; el.style.left=(x + (Math.random()-0.5)*40) + 'px'; el.style.top = y + 'px'; gameArea.appendChild(el); el.addEventListener('animationend', ()=> el.remove()); }

/* Balloons (always present in background as original) */
function spawnBalloon(type='normal'){
  if(balloons.length >= MAX_BALLOONS) return;
  const el=document.createElement('div'); el.className='balloon';
  let emoji='üéà', kind='pop', points=1;
  if(type==='unicorn'){ emoji='ü¶Ñ'; kind='unicorn'; points=3; }
  if(type==='bear'){ emoji='üß∏'; kind='bear'; points=2; }
  if(type==='cat'){ emoji='üê±'; kind='cat'; points=2; }
  el.textContent = emoji;
  const x = Math.random() * (window.innerWidth - 80) + 40;
  let y = window.innerHeight + 80;
  el.style.left = x + 'px'; el.style.top = y + 'px';
  gameArea.appendChild(el);
  const b = {el,x,y,vy:0.9 + Math.random()*1.6,sway:Math.random()*0.8,popped:false,kind,points};
  el.addEventListener('pointerdown', (ev)=>{ ev.stopPropagation(); if(b.popped) return; b.popped = true; popBalloon(b); }, {passive:true});
  balloons.push(b);
}

/* Pop balloon = acerto */
function popBalloon(b){
  try{ b.el.textContent='‚ú®'; b.el.style.transform='scale(1.12) rotate(6deg)'; }catch(e){}
  chime(b.kind);
  score += b.points; scoreEl.textContent = score;
  poppedCount++;
  const pool = (b.kind==='unicorn')?['‚ú®','üíñ','üåà']:(b.kind==='bear')?['üíñ','üß∏','‚ú®']:(b.kind==='cat')?['‚ú®','üêæ','üíñ']:['‚ú®','üíñ','üåü'];
  for(let i=0;i<8;i++) spawnParticleEmoji(b.x + (Math.random()-0.5)*30, b.y - 30 + (Math.random()-0.5)*20, pool[Math.floor(Math.random()*pool.length)]);
  setTimeout(()=>{ try{ b.el.remove(); }catch(e){} },240);

  // casual messages / mascots appear OUTSIDE the box (messageOut)
  if(MODE === 'casual'){
    const p = pickRandomDifferent(POP_PHRASES);
    showMessageOut(p,900);
    if(Math.random() < 0.35) spawnSmallMascot(b.x, b.y);
  }

  if(poppedCount % 5 === 0){
    const mp = pickRandomDifferent(MILESTONE_PHRASES);
    showMessageOut(mp,1200);
    chime('milestone'); spawnConfetti(window.innerWidth/2, window.innerHeight/2, 30);
    SPAWN_RATE = Math.max(400, SPAWN_RATE - 80); MAX_BALLOONS = Math.min(16, MAX_BALLOONS + 1);
  }
  checkUnlocks();
}

/* Offscreen balloon = erro em challenge */
function handleOffscreen(i){
  const b = balloons[i];
  if(!b) return;
  try{ b.el.remove(); }catch(e){}
  balloons.splice(i,1);
  if(MODE === 'challenge'){
    // errou (passou) -> perder vida
    LIVES -= 1; livesEl.textContent = LIVES; chime('bear');
    showMessageOut('Ops! Voc√™ perdeu uma vida', 900);
    if(LIVES <= 0) handleGameOver();
  }
}

/* Unlocks by score */
const UNLOCKS = [{score:5,key:'unicorn',emoji:'ü¶Ñ'},{score:12,key:'bear',emoji:'üß∏'},{score:20,key:'cat',emoji:'üê±'}];
let unlocked = new Set();
function checkUnlocks(){
  for(const u of UNLOCKS) if(score >= u.score && !unlocked.has(u.key)){ unlocked.add(u.key); spawnFloatingUnlock(u.emoji); spawnBalloon(u.key); const up = pickRandomDifferent(UNLOCK_PHRASES); showMessageOut(up,1100); }
}
function spawnFloatingUnlock(emoji){ const el=document.createElement('div'); el.className='floating-unlock'; el.textContent=emoji; const sx=window.innerWidth/2 + (Math.random()-0.5)*160; const sy=window.innerHeight*0.65 + (Math.random()-0.5)*40; el.style.left=sx+'px'; el.style.top=sy+'px'; gameArea.appendChild(el); el.addEventListener('animationend', ()=>el.remove()); }

/* show message OUTSIDE box (separate from boxMessage) */
function showMessageOut(txt,ms=1000){
  messageOut.innerText = txt;
  messageOut.style.display = 'block';
  clearTimeout(messageOut._t);
  messageOut._t = setTimeout(()=> messageOut.style.display = 'none', ms);
}

/* pickRandomDifferent helper already defined above */

let lastFrame = performance.now();

/* particles & animate */
function animate(now){
  const dt = now - lastFrame; lastFrame = now;
  if(now - lastSpawn > SPAWN_RATE){ if(Math.random() < 0.08){ const r=Math.random(); if(r<0.25) spawnBalloon('unicorn'); else if(r<0.55) spawnBalloon('bear'); else spawnBalloon('cat'); } else spawnBalloon('normal'); lastSpawn = now; }
  for(let i=balloons.length-1;i>=0;i--){ const b=balloons[i]; b.y -= b.vy * (dt/16); const sway = Math.sin((now/600) + b.sway*10) * 18; b.x += (sway * 0.0009) * (dt/16); if(b.el){ b.el.style.top = b.y + 'px'; b.el.style.left = b.x + 'px'; } if(b.y < -140) handleOffscreen(i); }
  // draw particles
  ctx.clearRect(0,0,fxCanvas.width,fxCanvas.height); const keep=[]; for(const p of particles){ const age = now - p.born; if(age > p.life) continue; p.vy += (p.gravity || 0.04) * (dt/16); p.x += p.vx * (dt/16); p.y += p.vy * (dt/16); const alpha = Math.max(0, 1 - (age / p.life)); ctx.globalAlpha = alpha; if(p.emoji){ ctx.font = (p.size || 18) + 'px serif'; ctx.fillText(p.emoji, p.x, p.y); } else { ctx.save(); ctx.translate(p.x,p.y); ctx.rotate((p.rot||0) * Math.PI/180 * (age/500)); ctx.fillStyle = p.color || '#fff'; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore(); } ctx.globalAlpha = 1; keep.push(p); } particles.length = 0; particles.push(...keep);
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

/* UI handlers */
effectsBtn.addEventListener('click', ()=>{ FX_ON = !FX_ON; effectsBtn.textContent = FX_ON ? 'üîä Efeitos: ON' : 'üîá Efeitos: OFF'; if(!audioCtx) initAudio(); });
menuOpen.addEventListener('click', ()=> { menuOverlay.style.display='flex'; menuOverlay.setAttribute('aria-hidden','false'); });
menuClose.addEventListener('click', ()=> { menuOverlay.style.display='none'; menuOverlay.setAttribute('aria-hidden','true'); });

document.getElementById('casualMode').addEventListener('click', ()=> setMode('casual'));
document.getElementById('challengeMode').addEventListener('click', ()=> setMode('challenge'));
document.getElementById('survivalMode').addEventListener('click', ()=> setMode('survival'));
document.getElementById('puzzleMode').addEventListener('click', ()=> setMode('puzzle'));

toggleSave.addEventListener('click', ()=> { RECORDS_ENABLED = !RECORDS_ENABLED; toggleSave.textContent = RECORDS_ENABLED ? 'Salvar: ON' : 'Salvar: OFF'; });

resetRecords.addEventListener('click', ()=> { localStorage.removeItem(KEY_BEST_SCORE); localStorage.removeItem(KEY_BEST_TIME); localStorage.removeItem(KEY_BEST_PUZZLE); updateRecordsUI(); showMessageOut('Records limpos',900); });

function setMode(m){
  for(const b of balloons) try{ b.el.remove(); }catch(e){} balloons=[]; particles=[]; score=0; poppedCount=0; scoreEl.textContent=score; SPAWN_RATE = 1100; MAX_BALLOONS = 8; LIVES = 5; livesEl.textContent = LIVES; unlocked.clear();
  MODE = m; modeBtn.textContent = 'Modo: ' + (m === 'casual' ? 'Casual' : m === 'challenge' ? 'Challenge' : m === 'survival' ? 'Survival' : 'Puzzle');
  if(m === 'casual'){ livesBox.style.display='none'; SPAWN_RATE = 1300; MAX_BALLOONS = 6; showMessageOut('Casual: S√≥ divers√£o!',900); }
  else if(m === 'challenge'){ livesBox.style.display='block'; SPAWN_RATE = 1000; MAX_BALLOONS = 8; LIVES = 5; livesEl.textContent = LIVES; showMessageOut('Challenge: cuidado com as vidas!',1200); }
  else if(m === 'survival'){ livesBox.style.display='none'; SPAWN_RATE = 1200; MAX_BALLOONS = 6; survivalStart = performance.now(); showMessageOut('Survival: quanto tempo?',1000); }
  else if(m === 'puzzle'){ livesBox.style.display='none'; showMessageOut('Abrindo Puzzle...',800); /* puzzle open handled elsewhere if implemented */ }
}

/* Present open/close behavior ‚Äî RESTORE original look & keep corrections */
let boxOpen = false;
presentBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); toggleBox(); });

function toggleBox(){ boxOpen = !boxOpen; if(boxOpen) openBox(); else closeBox(); }

function openBox(){
  boxOverlay.style.display = 'flex'; boxOverlay.setAttribute('aria-hidden','false'); boxMessage.textContent = `FELIZ ANIVERS√ÅRIO, ${CHILD}!!`;
  createCandles(); candleClicks = 0;
  // play small confetti and sound
  spawnConfetti(window.innerWidth/2, window.innerHeight/2, 12);
  if(!audioCtx) initAudio();
  // do not remove balloons ‚Äî they remain in background as original
}

function closeBox(){
  boxOverlay.style.display = 'none'; boxOverlay.setAttribute('aria-hidden','true');
  // reset candles only when reopening (we do not persist extinguish)
}

/* create 3 candles and attach click handler */
function createCandles(){
  candlesContainer.innerHTML = '';
  for(let i=0;i<3;i++){
    const v = document.createElement('div'); v.className = 'vela'; v.innerText = 'üïØÔ∏è';
    v.dataset.idx = i;
    v.addEventListener('click', ()=>{ handleCandleClick(v); }, {passive:true});
    candlesContainer.appendChild(v);
  }
}

/* Candle click logic: after 3 total clicks across any candles -> extinguish all */
function handleCandleClick(el){
  if(!audioCtx) initAudio();
  chime('pop');
  candleClicks++;
  if(candleClicks >= 3){
    // extinguish: show smoke emoji in each slot and boxMessage updated
    const velas = candlesContainer.querySelectorAll('.vela');
    velas.forEach(v => v.textContent = 'üí®');
    boxMessage.textContent = `Voc√™ apagou as velinhas! Parab√©ns, ${CHILD}! üéÇ‚ú®`;
    spawnConfetti(window.innerWidth/2, window.innerHeight/2, 30);
    // show outside message as well
    showMessageOut(`Voc√™ apagou as velinhas, ${CHILD}!`, 2000);
  } else {
    const left = 3 - candleClicks;
    showMessageOut(`Faltam ${left} sopros`, 800);
  }
}

/* Records UI */
function updateRecordsUI(){ bestScoreEl.textContent = parseInt(localStorage.getItem(KEY_BEST_SCORE) || '0',10); bestTimeEl.textContent = Math.round(parseFloat(localStorage.getItem(KEY_BEST_TIME) || '0')); bestPuzzleEl.textContent = parseInt(localStorage.getItem(KEY_BEST_PUZZLE) || '0',10); }
updateRecordsUI();

/* Game over for challenge */
function handleGameOver(){
  SPAWN_RATE = 999999;
  showMessageOut('Game Over üòÖ',1800);
  if(RECORDS_ENABLED){
    const best = parseInt(localStorage.getItem(KEY_BEST_SCORE) || '0',10);
    if(score > best){ localStorage.setItem(KEY_BEST_SCORE, String(score)); updateRecordsUI(); showMessageOut('Novo recorde! üèÜ',1500); }
  }
  setTimeout(()=>{ centerMsg.innerHTML = 'Game Over<br><button id="restartAfterGame" class="btn">Reiniciar</button>'; centerMsg.style.display='block'; const btn = document.getElementById('restartAfterGame'); if(btn) btn.addEventListener('click', ()=>{ centerMsg.style.display='none'; setMode('challenge'); }); }, 600);
}

/* Ensure audio unlocked on first touch */
document.body.addEventListener('pointerdown', ()=>{ if(!audioCtx) initAudio(); if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{}); }, {once:true,passive:true});

/* initial defaults restored */
setMode('casual');
scoreEl.textContent = score;
livesEl.textContent = LIVES;

/* Utility restart */
function restartAll(){ for(const b of balloons) try{ b.el.remove(); }catch(e){} balloons=[]; particles=[]; score=0; poppedCount=0; scoreEl.textContent=0; SPAWN_RATE=1100; MAX_BALLOONS=8; LIVES=5; livesEl.textContent=LIVES; unlocked.clear(); showMessageOut('Reiniciado',800); }
document.addEventListener('keydown', (e)=>{ if(e.key === 'r') restartAll(); });

/* Visibility save */
window.addEventListener('visibilitychange', ()=> { if(document.hidden && RECORDS_ENABLED){ const best = parseInt(localStorage.getItem(KEY_BEST_SCORE) || '0',10); if(score > best) localStorage.setItem(KEY_BEST_SCORE, String(score)); } });

/* animate loop already defined above ‚Äî ensure particles array exists */
if(typeof particles === 'undefined') var particles = [];

/* To avoid accidental missing variables: ensure lastSpawn is set */
lastSpawn = performance.now();

/* Final check: start with a few balloons for visual */
for(let i=0;i<3;i++) setTimeout(()=> spawnBalloon(), i*300);

</script>
</body>
</html>
